generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
enum Role {
  GM
  REGION_MANAGER
  DELEGATE
}
model User {
  id        String          @id @default(uuid())
  name      String
  email     String          @unique
  password  String
  role      Role
  regions   RegionManager[]
  delegates Delegate[]
  createdAt DateTime      @default(now())
  updatedAt DateTime        @updatedAt
  deletedAt DateTime?
}

model Region {
  id        String          @id @default(uuid())
  name      String          @unique
  managers  RegionManager[]
  delegates Delegate[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([name])
}

model RegionManager {
  id        String   @id @default(uuid())
  userId    String
  regionId  String
  startAt   DateTime @default(now())
  endAt     DateTime?
  user      User     @relation(fields:[userId], references: [id], onDelete: Restrict)
  region    Region   @relation(fields:[regionId], references: [id], onDelete: Restrict)
  delegates Delegate[]

  @@unique([userId, regionId, startAt])
  @@index([regionId])
  @@index([regionId, endAt])
  @@index([userId, endAt])
}

model Delegate {
  id        String         @id @default(uuid())
  name      String
  phone     String?
  regionId  String
  userId    String?        @unique
  managerId String

  region    Region         @relation(fields: [regionId], references: [id], onDelete: Restrict)
  user      User?          @relation(fields: [userId], references: [id])
  manager   RegionManager  @relation(fields: [managerId], references: [id], onDelete: Restrict)

  members   Member[]
  payments  Payment[]      @relation(name: "DelegatePayments")

  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  deletedAt DateTime?

  @@index([regionId])
  @@index([managerId])
}

model Member {
  id         String     @id @default(uuid())
  cin        String     @unique
  fullName   String
  status     String     @default("ACTIVE")
  delegateId String

  delegate   Delegate   @relation(fields: [delegateId], references: [id], onDelete: Restrict)
  payments   Payment[]  @relation(name: "MemberPayments")

  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([delegateId])
}
model Payment {
  id          String   @id @default(uuid())
  memberId    String
  delegateId  String?  // nullable pour audit quand un délégué est supprimé
  amount      Decimal  @db.Decimal(12, 2)
  paidAt      DateTime @default(now())

  // doit matcher Member.payments
  // VOCI LA CORRECTION (tout sur une ligne)
  member      Member   @relation(name: "MemberPayments", fields: [memberId], references: [id], onDelete: Restrict)

  // doit matcher Delegate.payments
  // VOCI LA CORRECTION (tout sur une ligne)
  delegate    Delegate? @relation(name: "DelegatePayments", fields: [delegateId], references: [id], onDelete: SetNull)

  @@index([memberId])
  @@index([delegateId, paidAt])
}
